name: Post new blog to Bluesky (After Vercel Deploy)

# 1. è§¦å‘æ¡ä»¶
on:
  deployment_status:

jobs:
  bluesky-post-on-success:
    if: github.event.deployment_status.state == 'success'

    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ
        run: |
          echo "Deployment Environment: ${{ github.event.deployment.environment }}"
          echo "Deployment Ref (Branch/SHA): ${{ github.event.deployment.ref }}"

      - name: æ£€æŸ¥æ˜¯å¦ä¸º 'main' åˆ†æ”¯çš„ç”Ÿäº§éƒ¨ç½²
        if: github.event.deployment.environment != 'Production' || github.event.deployment.ref != 'main'
        run: |
          echo "Skipping Bluesky post: Not a successful 'main' branch Production deployment."
          exit 0

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.deployment.sha }}
          # Fetch the previous commit as well to compare changes
          fetch-depth: 2

      - name: Detect new MDX files
        id: changes
        run: |
          # æŸ¥æ‰¾ zh-contents/ æˆ– contents/ ç›®å½•ä¸‹æ–°å¢çš„ .mdx æ–‡ä»¶
          NEW_FILES=$(git diff --name-status HEAD~1 HEAD | awk '$1=="A" && $2 ~ /^(zh-contents\/|contents\/).*\.mdx$/ {print $2}' | tr '\n' ' ')

          # ç§»é™¤æœ«å°¾ç©ºæ ¼å¹¶è®¾ç½®è¾“å‡º
          NEW_FILES=$(echo "$NEW_FILES" | sed 's/[[:space:]]*$//')

          echo "Detected new files: $NEW_FILES"

          # ä½¿ç”¨å¤šè¡Œè¾“å‡ºæ ¼å¼é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
          {
            echo "new_files<<EOF"
            echo "$NEW_FILES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: If no new files, stop
        if: steps.changes.outputs.new_files == ''
        run: echo "No new blog posts detected in this deployment."

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install gray-matter @atproto/api

      - name: Post each new article to Bluesky
        if: steps.changes.outputs.new_files != ''
        run: |
          for file in ${{ steps.changes.outputs.new_files }}; do
            echo "Processing $file"
            
            # --- 1. ç¡®å®š URL å‰ç¼€ ---
            if [[ "$file" == zh-contents/* ]]; then
              PATH_PREFIX="zh-blog"
            elif [[ "$file" == contents/* ]]; then
              PATH_PREFIX="blog"
            else
              echo "Error: File $file does not match expected content directories. Skipping."
              continue
            fi
            
            # --- 2. æå– Title (ä» frontmatter) ---
            TITLE=$(node - <<EOF
const fs = require("fs");
const matter = require("gray-matter");
const content = fs.readFileSync("$file", "utf8");
const data = matter(content).data;
console.log(data.title || "$file");
EOF
) 

            # --- 3. ä»æ–‡ä»¶åç”Ÿæˆ SLUG (æœ€å¯é çš„æ–¹å¼) ---
            FILENAME=$(basename "$file") 
            SLUG="${FILENAME%.*}"
            
            # --- 4. ç»„åˆæœ€ç»ˆ URL ---
            POST_URL="${{ env.BLOG_DOMAIN }}/${PATH_PREFIX}/${SLUG}"
            
            echo "Generated URL: $POST_URL"

            # --- 5. å‘åˆ° Bluesky ---
            node - <<EOF
import { BskyAgent } from "@atproto/api";
const agent = new BskyAgent({ service: "https://bsky.social" });

const USERNAME = process.env.BLUESKY_USERNAME;
const PASSWORD = process.env.BLUESKY_PASSWORD;
const POST_URL_JS = "$POST_URL";
const ARTICLE_TITLE = "$TITLE";

await agent.login({ identifier: USERNAME, password: PASSWORD });

const text = \`ğŸ“¢ æ–°åšå®¢å‘å¸ƒï¼š${ARTICLE_TITLE}\n\né˜…è¯»é“¾æ¥ï¼š\${POST_URL_JS}\`;

await agent.post({
  text,
});

console.log("Posted to Bluesky:", text);
EOF 

          done
        env:
          BLUESKY_USERNAME: ${{ secrets.BLUESKY_USERNAME }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          BLOG_DOMAIN: https://yuuka168.com