name: Post new blog to Bluesky (After Vercel Deploy)

# 1. è§¦å‘æ¡ä»¶
on:
  # ç›‘å¬ deployment_status äº‹ä»¶
  deployment_status:

jobs:
  bluesky-post-on-success:
    # åªæœ‰å½“éƒ¨ç½²çŠ¶æ€æ˜¯ 'success' æ—¶æ‰è¿è¡Œæ­¤ä½œä¸š
    if: github.event.deployment_status.state == 'success'

    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ
        run: |
          echo "Deployment Environment: ${{ github.event.deployment.environment }}"
          echo "Deployment Ref (Branch/SHA): ${{ github.event.deployment.ref }}"

      # ä»…å¤„ç† main åˆ†æ”¯çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
      - name: æ£€æŸ¥æ˜¯å¦ä¸º 'main' åˆ†æ”¯çš„ç”Ÿäº§éƒ¨ç½²
        if: github.event.deployment.environment != 'Production' || github.event.deployment.ref != 'main'
        run: |
          echo "Skipping Bluesky post: Not a successful 'main' branch Production deployment."
          exit 0 # æå‰é€€å‡ºä½œä¸šï¼Œä¸æ‰§è¡Œåç»­æ­¥éª¤

      - name: Checkout repo
        uses: actions/checkout@v4
        # å¿…é¡»æ£€å‡º Vercel åˆšåˆšéƒ¨ç½²çš„é‚£ä¸ªæäº¤
        with:
          ref: ${{ github.event.deployment.sha }}
          # Fetch the previous commit as well to compare changes
          fetch-depth: 2

      # ----------------------------------------------------
      # ä»¥ä¸‹æ­¥éª¤å’Œæ‚¨åŸæœ‰çš„é€»è¾‘ç±»ä¼¼ï¼Œä½† 'git diff' çš„ç”¨æ³•éœ€è¦è°ƒæ•´
      # ----------------------------------------------------

      - name: Detect new MDX files
        id: changes
        run: |
          # æ¯”è¾ƒå½“å‰æäº¤ (HEAD) å’Œå‰ä¸€ä¸ªæäº¤ (HEAD~1) çš„æ–‡ä»¶å˜åŠ¨
          # æ³¨æ„ï¼šVercel éƒ¨ç½²é€šå¸¸é’ˆå¯¹æ•´ä¸ªä»“åº“çš„ SHAï¼Œæ‰€ä»¥è¿™ä¸ª diff æ˜¯å‡†ç¡®çš„
          NEW_FILES=$(git diff --name-status HEAD~1 HEAD | awk '$1=="A" && $2 ~ /\.mdx$/ {print $2}')
          echo "new_files=$NEW_FILES" >> $GITHUB_OUTPUT

      - name: If no new files, stop
        if: steps.changes.outputs.new_files == ''
        run: echo "No new blog posts detected in this deployment."

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install gray-matter @atproto/api
        # Vercel éƒ¨ç½²å®Œæˆåï¼Œæ‰€æœ‰çš„æ–‡ä»¶å’Œä¾èµ–éƒ½åœ¨è¯¥æäº¤ä¸­ï¼Œå¯ä»¥ç›´æ¥å®‰è£…

      - name: Post each new article to Bluesky
        if: steps.changes.outputs.new_files != ''
        run: |
          for file in ${{ steps.changes.outputs.new_files }}; do
            echo "Processing $file"
            
            # æå– title (ä» frontmatter)
            TITLE=$(node - <<EOF
            const fs = require("fs");
            const matter = require("gray-matter");
            const content = fs.readFileSync("$file", "utf8");
            const data = matter(content).data;
            console.log(data.title || "$file");
            EOF
            )

            # ----------------------------------------------------
            # å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨è‡ªå®šä¹‰åŸŸå/ç¨³å®šåŸŸå
            # ----------------------------------------------------
            
            # ç¡®ä¿é“¾æ¥åœ¨éƒ¨ç½²æˆåŠŸåæ˜¯å¯è®¿é—®çš„
            # å‡è®¾æ‚¨çš„åšå®¢è·¯å¾„æ ¼å¼ä¸º /blog/[slug]
            SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
            POST_URL="${{ env.BLOG_DOMAIN }}/blog/${SLUG}"
            
            echo "Generated URL: $POST_URL"

            # å‘åˆ° Bluesky
            node - <<EOF
            import { BskyAgent } from "@atproto/api";
            const agent = new BskyAgent({ service: "https://bsky.social" });

            const USERNAME = process.env.BLUESKY_USERNAME;
            const PASSWORD = process.env.BLUESKY_PASSWORD;
            const POST_URL = "$POST_URL"; // ä½¿ç”¨ Bash/Env å˜é‡

            await agent.login({ identifier: USERNAME, password: PASSWORD });

            const text = \`ğŸ“¢ æ–°åšå®¢å‘å¸ƒï¼š${TITLE}\n\né˜…è¯»é“¾æ¥ï¼š\${POST_URL}\`;

            await agent.post({
              text,
            });

            console.log("Posted to Bluesky:", text);
            EOF

          done
        env:
          BLUESKY_USERNAME: ${{ secrets.BLUESKY_USERNAME }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          # â—ï¸ æ›¿æ¢ä¸ºæ‚¨çš„è‡ªå®šä¹‰åŸŸåï¼Œè¿™æ˜¯éƒ¨ç½²æˆåŠŸåèƒ½ç¨³å®šè®¿é—®çš„åŸŸå
          BLOG_DOMAIN: https://yuuka168.com # æˆ–è€…æ‚¨çš„è‡ªå®šä¹‰åŸŸå
