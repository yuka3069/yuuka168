name: Post new blog to Bluesky (After Vercel Deploy)

on:
  deployment_status:

jobs:
  bluesky-post-on-success:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: 检查部署环境
        run: |
          echo "Deployment Environment: ${{ github.event.deployment.environment }}"
          echo "Deployment Ref (Branch/SHA): ${{ github.event.deployment.ref }}"

      - name: 检查是否为 'main' 分支的生产部署
        if: github.event.deployment.environment != 'Production' || github.event.deployment.ref != 'main'
        run: |
          echo "Skipping Bluesky post: Not a successful 'main' branch Production deployment."
          exit 0

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.deployment.sha }}
          fetch-depth: 2

      - name: Detect new MDX files
        id: changes
        run: |
          # 查找 zh-contents/ 或 contents/ 目录下新增的 .mdx 文件
          NEW_FILES=$(git diff --name-status HEAD~1 HEAD | awk '$1=="A" && $2 ~ /^(zh-contents\/|contents\/).*\.mdx$/ {print $2}' | tr '\n' ' ')
          NEW_FILES=$(echo "$NEW_FILES" | sed 's/[[:space:]]*$//')

          echo "Detected new files: $NEW_FILES"

          {
            echo "new_files<<EOF"
            echo "$NEW_FILES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: If no new files, stop
        if: steps.changes.outputs.new_files == ''
        run: echo "No new blog posts detected in this deployment."

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install gray-matter @atproto/api mime-types

      - name: Post each new article to Bluesky
        if: steps.changes.outputs.new_files != ''
        run: |
          for file in ${{ steps.changes.outputs.new_files }}; do
            echo "Processing $file"
            
            # --- 1. 确定 URL 前缀 ---
            if [[ "$file" == zh-contents/* ]]; then
              PATH_PREFIX="zh-blog"
            elif [[ "$file" == contents/* ]]; then
              PATH_PREFIX="blog"
            else
              echo "Error: File $file does not match expected content directories. Skipping."
              continue
            fi
            
            # --- 2. 从文件名生成 SLUG ---
            FILENAME=$(basename "$file") 
            SLUG="${FILENAME%.*}"
            
            # --- 3. 组合最终 URL ---
            POST_URL="${{ env.BLOG_DOMAIN }}/${PATH_PREFIX}/${SLUG}"
            echo "Generated URL: $POST_URL"

            # --- 4. Node.js 脚本：读取元数据并发送带有缩略图的卡片 ---
            node -e "
              const fs = require('fs');
              const path = require('path');
              const matter = require('gray-matter');
              const { BskyAgent } = require('@atproto/api');
              const mime = require('mime-types');

              (async () => {
                try {
                  // --- A. 读取 MDX 获取 Title, Summary, Image ---
                  const fileContent = fs.readFileSync('$file', 'utf8');
                  const { data } = matter(fileContent);
                  
                  const title = data.title || '$file';
                  // 使用 summary 或 description，如果没有则留空
                  const description = data.summary || data.description || data.abstract || ''; 
                  
                  // --- B. 确定图片路径 (优先级: Frontmatter > 默认 banner) ---
                  // 假设 repo 根目录就是 checkout 的目录
                  let imagePath = 'public/images/twitter-card.png'; // 默认回退 (siteMetadata.socialBanner)
                  
                  if (data.images && Array.isArray(data.images) && data.images.length > 0) {
                    imagePath = path.join('public', data.images[0]);
                  } else if (data.image) {
                     imagePath = path.join('public', data.image);
                  }

                  // 修正路径：有些 Next.js配置中引用图片可能带 /static 或直接 /images
                  // 如果路径以 / 开头，去掉它以便 fs.readFileSync 能找到 (相对于当前工作目录)
                  if (imagePath.startsWith('/')) {
                    imagePath = imagePath.substring(1); 
                    // 如果不是以 public 开头，加上 public (Next.js 惯例)
                    if (!imagePath.startsWith('public/')) {
                         imagePath = path.join('public', imagePath);
                    }
                  }

                  console.log('Target Image Path:', imagePath);

                  // --- C. 登录 Bluesky ---
                  const agent = new BskyAgent({ service: 'https://bsky.social' });
                  const USERNAME = process.env.BLUESKY_USERNAME;
                  const PASSWORD = process.env.BLUESKY_PASSWORD;
                  
                  if (!USERNAME || !PASSWORD) {
                    console.error('Missing Bluesky credentials');
                    process.exit(1);
                  }
                  
                  await agent.login({ identifier: USERNAME, password: PASSWORD });

                  // --- D. 上传图片 Blob (如果图片存在) ---
                  let thumbBlob = undefined;
                  
                  if (fs.existsSync(imagePath)) {
                    const fileBuf = fs.readFileSync(imagePath);
                    const mimeType = mime.lookup(imagePath) || 'image/jpeg';
                    
                    // 限制上传大小 (Bluesky 限制约 1MB，这里做个简单检查，一般 banner 不会太大)
                    if (fileBuf.length < 900000) {
                        const { data: uploadData } = await agent.uploadBlob(fileBuf, { encoding: mimeType });
                        thumbBlob = uploadData.blob;
                        console.log('Image uploaded successfully.');
                    } else {
                        console.warn('Image too large for Bluesky blob (>900kb), skipping thumbnail.');
                    }
                  } else {
                    console.warn('Image file not found on disk:', imagePath);
                  }

                  // --- E. 发送带有 Embed Card 的帖子 ---
                  const postText = \`\${title}\n\${description}\`;
                  
                  await agent.post({
                    text: postText,
                    embed: {
                      \$type: 'app.bsky.embed.external',
                      external: {
                        uri: '$POST_URL',
                        title: title,
                        description: description,
                        thumb: thumbBlob // 如果是 undefined，Bluesky 会显示无图卡片
                      }
                    }
                  });
                  
                  console.log('Posted to Bluesky with Link Card:', title);
                  
                } catch (error) {
                  console.error('Error posting to Bluesky:', error);
                  process.exit(1);
                }
              })();
            " 

          done
        env:
          BLUESKY_USERNAME: ${{ secrets.BLUESKY_USERNAME }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          BLOG_DOMAIN: https://yuuka168.com
