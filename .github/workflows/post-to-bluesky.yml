name: Post new blog to Bluesky (After Vercel Deploy)

on:
  deployment_status:

jobs:
  bluesky-post-on-success:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ
        run: |
          echo "Deployment Environment: ${{ github.event.deployment.environment }}"
          echo "Deployment Ref (Branch/SHA): ${{ github.event.deployment.ref }}"

      - name: æ£€æŸ¥æ˜¯å¦ä¸º 'main' åˆ†æ”¯çš„ç”Ÿäº§éƒ¨ç½²
        if: github.event.deployment.environment != 'Production' || github.event.deployment.ref != 'main'
        run: |
          echo "Skipping Bluesky post: Not a successful 'main' branch Production deployment."
          exit 0

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.deployment.sha }}
          fetch-depth: 2

      - name: Detect new MDX files
        id: changes
        run: |
          # æŸ¥æ‰¾ zh-contents/ æˆ– contents/ ç›®å½•ä¸‹æ–°å¢çš„ .mdx æ–‡ä»¶
          NEW_FILES=$(git diff --name-status HEAD~1 HEAD | awk '$1=="A" && $2 ~ /^(zh-contents\/|contents\/).*\.mdx$/ {print $2}' | tr '\n' ' ')
          NEW_FILES=$(echo "$NEW_FILES" | sed 's/[[:space:]]*$//')

          echo "Detected new files: $NEW_FILES"

          {
            echo "new_files<<EOF"
            echo "$NEW_FILES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: If no new files, stop
        if: steps.changes.outputs.new_files == ''
        run: echo "No new blog posts detected in this deployment."

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # æ–°å¢ mime-types ä¾èµ–
      - name: Install dependencies
        run: npm install gray-matter @atproto/api mime-types

      - name: Post each new article to Bluesky
        if: steps.changes.outputs.new_files != ''
        run: |
          for file in ${{ steps.changes.outputs.new_files }}; do
            echo "Processing $file"
            
            # --- 1. ç¡®å®š URL å‰ç¼€ ---
            if [[ "$file" == zh-contents/* ]]; then
              PATH_PREFIX="zh-blog"
            elif [[ "$file" == contents/* ]]; then
              PATH_PREFIX="blog"
            else
              echo "Error: File $file does not match expected content directories. Skipping."
              continue
            fi
            
            # --- 2. ä»æ–‡ä»¶åç”Ÿæˆ SLUG ---
            FILENAME=$(basename "$file") 
            SLUG="${FILENAME%.*}"
            
            # --- 3. ç»„åˆæœ€ç»ˆ URL ---
            POST_URL="${{ env.BLOG_DOMAIN }}/${PATH_PREFIX}/${SLUG}"
            echo "Generated URL: $POST_URL"

            # --- 4. Node.js è„šæœ¬ï¼šè¯»å–å…ƒæ•°æ®å¹¶å‘é€å¸¦æœ‰ç¼©ç•¥å›¾çš„å¡ç‰‡ ---
            node -e "
              const fs = require('fs');
              const path = require('path');
              const matter = require('gray-matter');
              const { BskyAgent } = require('@atproto/api');
              const mime = require('mime-types');

              (async () => {
                try {
                  // --- A. è¯»å– MDX è·å– Title, Summary, Image ---
                  const fileContent = fs.readFileSync('$file', 'utf8');
                  const { data } = matter(fileContent);
                  
                  const title = data.title || '$file';
                  // ä½¿ç”¨ summary æˆ– descriptionï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©º
                  const description = data.summary || data.description || ''; 
                  
                  // --- B. ç¡®å®šå›¾ç‰‡è·¯å¾„ (ä¼˜å…ˆçº§: Frontmatter > é»˜è®¤ banner) ---
                  // å‡è®¾ repo æ ¹ç›®å½•å°±æ˜¯ checkout çš„ç›®å½•
                  let imagePath = 'public/images/twitter-card.png'; // é»˜è®¤å›é€€ (siteMetadata.socialBanner)
                  
                  if (data.images && Array.isArray(data.images) && data.images.length > 0) {
                    imagePath = path.join('public', data.images[0]);
                  } else if (data.image) {
                     imagePath = path.join('public', data.image);
                  }

                  // ä¿®æ­£è·¯å¾„ï¼šæœ‰äº› Next.jsé…ç½®ä¸­å¼•ç”¨å›¾ç‰‡å¯èƒ½å¸¦ /static æˆ–ç›´æ¥ /images
                  // å¦‚æœè·¯å¾„ä»¥ / å¼€å¤´ï¼Œå»æ‰å®ƒä»¥ä¾¿ fs.readFileSync èƒ½æ‰¾åˆ° (ç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•)
                  if (imagePath.startsWith('/')) {
                    imagePath = imagePath.substring(1); 
                    // å¦‚æœä¸æ˜¯ä»¥ public å¼€å¤´ï¼ŒåŠ ä¸Š public (Next.js æƒ¯ä¾‹)
                    if (!imagePath.startsWith('public/')) {
                         imagePath = path.join('public', imagePath);
                    }
                  }

                  console.log('Target Image Path:', imagePath);

                  // --- C. ç™»å½• Bluesky ---
                  const agent = new BskyAgent({ service: 'https://bsky.social' });
                  const USERNAME = process.env.BLUESKY_USERNAME;
                  const PASSWORD = process.env.BLUESKY_PASSWORD;
                  
                  if (!USERNAME || !PASSWORD) {
                    console.error('Missing Bluesky credentials');
                    process.exit(1);
                  }
                  
                  await agent.login({ identifier: USERNAME, password: PASSWORD });

                  // --- D. ä¸Šä¼ å›¾ç‰‡ Blob (å¦‚æœå›¾ç‰‡å­˜åœ¨) ---
                  let thumbBlob = undefined;
                  
                  if (fs.existsSync(imagePath)) {
                    const fileBuf = fs.readFileSync(imagePath);
                    const mimeType = mime.lookup(imagePath) || 'image/jpeg';
                    
                    // é™åˆ¶ä¸Šä¼ å¤§å° (Bluesky é™åˆ¶çº¦ 1MBï¼Œè¿™é‡Œåšä¸ªç®€å•æ£€æŸ¥ï¼Œä¸€èˆ¬ banner ä¸ä¼šå¤ªå¤§)
                    if (fileBuf.length < 900000) {
                        const { data: uploadData } = await agent.uploadBlob(fileBuf, { encoding: mimeType });
                        thumbBlob = uploadData.blob;
                        console.log('Image uploaded successfully.');
                    } else {
                        console.warn('Image too large for Bluesky blob (>900kb), skipping thumbnail.');
                    }
                  } else {
                    console.warn('Image file not found on disk:', imagePath);
                  }

                  // --- E. å‘é€å¸¦æœ‰ Embed Card çš„å¸–å­ ---
                  const postText = \`ğŸ“¢ æ–°åšå®¢å‘å¸ƒï¼š\${title}\`;
                  
                  await agent.post({
                    text: postText,
                    embed: {
                      \$type: 'app.bsky.embed.external',
                      external: {
                        uri: '$POST_URL',
                        title: title,
                        description: description,
                        thumb: thumbBlob // å¦‚æœæ˜¯ undefinedï¼ŒBluesky ä¼šæ˜¾ç¤ºæ— å›¾å¡ç‰‡
                      }
                    }
                  });
                  
                  console.log('Posted to Bluesky with Link Card:', title);
                  
                } catch (error) {
                  console.error('Error posting to Bluesky:', error);
                  process.exit(1);
                }
              })();
            " 

          done
        env:
          BLUESKY_USERNAME: ${{ secrets.BLUESKY_USERNAME }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          BLOG_DOMAIN: https://yuuka168.com
